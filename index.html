<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Monkey is Sexy!">
<meta property="og:url" content="https://monkeyissexy.github.io/index.html">
<meta property="og:site_name" content="Monkey is Sexy!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Monkey is Sexy!">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="https://monkeyissexy.github.io/"/>

  <title> Monkey is Sexy! </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e3eaf9cb0e468d1de706431e5cafa74f";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Monkey is Sexy!</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/02/redis-sentinel/" itemprop="url">
                  Redis Sentinel 入门搭建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-02T19:58:17+08:00" content="2016-08-02">
              2016-08-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/02/redis-sentinel/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/02/redis-sentinel/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="redis-sentinel-2-8-x-搭建"><a href="#redis-sentinel-2-8-x-搭建" class="headerlink" title="redis sentinel (2.8.x)搭建"></a>redis sentinel (2.8.x)搭建</h2><blockquote>
<p>本来使用的是最新稳定版3.2.2，这个版本对redis的安全性方面，也做了很多改进，但是在搭建好之后，连接sentinel的时候，出现和protected-mode相关的问题，google了下没有解决，所以讲版本降低到2.8.24版本进行测试。2.8.x版本中sentinel2已经是稳定版了，所以不影响演示，等有时间了把3.2.2的那个问题给解决了，再更新。。。</p>
</blockquote>
<h3 id="入门搭建演示"><a href="#入门搭建演示" class="headerlink" title="入门搭建演示"></a>入门搭建演示</h3><p>好了，让我们开始吧！</p>
<p>首先，从官网下载2.8版本redis源文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget http://download.redis.io/releases/redis-2.8.24.tar.gz</div><div class="line">tar xzf redis-2.8.24.tar.gz</div><div class="line">cd redis-2.8.24</div><div class="line">make</div><div class="line">make test</div></pre></td></tr></table></figure>
<p>资源有限，单机部署，原理是一样的</p>
<p>源文件下载之后，执行编译命令，之后将redis目录cp为以下三个：</p>
<ul>
<li>redis6377</li>
<li>redis6378</li>
<li>redis6379</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">➜  redis_ha2 pwd</div><div class="line">/Users/whl/redis_ha2</div><div class="line">➜  redis_ha2 ll</div><div class="line">total 2472</div><div class="line">-rw-r--r--   1 whl  staff   1.2M 12 18  2015 redis-2.8.24.tar.gz</div><div class="line">drwxr-xr-x  20 whl  staff   680B  8  2 18:55 redis6377</div><div class="line">drwxr-xr-x  19 whl  staff   646B  8  2 18:51 redis6378</div><div class="line">drwxr-xr-x  19 whl  staff   646B  8  2 18:51 redis6379</div></pre></td></tr></table></figure>
<p>现在我们有三个redis实例目录了，redis集群中，我们把redis6379设置为<code>master</code>，配置文件修改</p>
<blockquote>
<p>为了方便，没有设置密码 masterauth、requirepass </p>
</blockquote>
<ul>
<li>redis6377中的redis.conf、sentinel.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">redis.conf中需要修改以下三个配置</div><div class="line">	daemonize yes</div><div class="line">	pidfile &quot;/var/run/redis_6377.pid&quot;</div><div class="line">	port 6377</div><div class="line"></div><div class="line">sentinel.conf中需要修改以下三个配置，其它使用默认值</div><div class="line">	daemonize yes （原本没有，需添加）</div><div class="line">	port 26377</div><div class="line">	sentinel monitor mymaster 172.30.8.109 6379 2</div></pre></td></tr></table></figure>
<ul>
<li>redis6378中的redis.conf、sentinel.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">redis.conf中需要修改以下三个配置</div><div class="line">	daemonize yes</div><div class="line">	pidfile &quot;/var/run/redis_6378.pid&quot;</div><div class="line">	port 6378</div><div class="line"></div><div class="line">sentinel.conf中需要修改以下三个配置，其它使用默认值</div><div class="line">	daemonize yes （原本没有，需添加）</div><div class="line">	port 26378</div><div class="line">	sentinel monitor mymaster 172.30.8.109 6379 2</div></pre></td></tr></table></figure>
<ul>
<li>redis6379中的redis.conf、sentinel.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">redis.conf中需要修改以下三个配置</div><div class="line">	daemonize yes</div><div class="line">	pidfile &quot;/var/run/redis_6379.pid&quot;</div><div class="line">	port 6379</div><div class="line"></div><div class="line">sentinel.conf中需要修改以下三个配置，其它使用默认值</div><div class="line">	daemonize yes （原本没有，需添加）</div><div class="line">	port 26379</div><div class="line">	sentinel monitor mymaster 172.30.8.109 6379 2</div></pre></td></tr></table></figure>
<p> 从以上配置文件sentinel.conf中，可以看到，monitor只需要配置master信息，sentinel自己会通过master找到它所关联的salves，所以我们不需要显示的告诉sentinel，谁是salves；</p>
<p>启动redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis6377/src/redis-server redis6377/redis.conf</div><div class="line">redis6378/src/redis-server redis6378/redis.conf</div><div class="line">redis6379/src/redis-server redis6379/redis.conf</div></pre></td></tr></table></figure>
<p>现在，这三个redis的role都是<code>master</code>，之间没有任何关系，下面，就需要将master-salve关系建立起来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">执行slaveof命令，告诉两个redis实例，你们从属于6379实例</div><div class="line"></div><div class="line">telnet localhost 6377</div><div class="line">slaveof 172.30.8.109 6379</div><div class="line"></div><div class="line">telnet localhost 6378</div><div class="line">slaveof 172.30.8.109 6379</div></pre></td></tr></table></figure>
<p>此时，登录到6379实例上，我们可以看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Replication</div><div class="line">role:master</div><div class="line">connected_slaves:2</div><div class="line">slave0:ip=172.30.8.109,port=6377,state=online,offset=469317,lag=0</div><div class="line">slave1:ip=172.30.8.109,port=6378,state=online,offset=469317,lag=0</div></pre></td></tr></table></figure>
<p>登录到6377、6378实例上，我们可以看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Replication</div><div class="line">role:slave</div><div class="line">master_host:172.30.8.109</div><div class="line">master_port:6379</div><div class="line">master_link_status:up</div></pre></td></tr></table></figure>
<p>根据以上信息，说明redis的master-slave集群搭建的没有问题。</p>
<p>下面我们启动sentinel实例</p>
<blockquote>
<p>redis官方要求，一个健壮的sentinel集群，最低要求是三个实例，因为要保证大多数的sentinel工作正常，才能进行后续的failover操作；ps：这块很类似zookeeper的部署要求，2n+1个实例，最低要求也是3台，这块的协议redis和zookeeper好像用的同一个gossip协议；</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">redis6377/src/redis-sentinel redis6377/sentinel.conf</div><div class="line">redis6378/src/redis-sentinel redis6378/sentinel.conf</div><div class="line">redis6379/src/redis-sentinel redis6379/sentinel.conf</div></pre></td></tr></table></figure>
<p>此时，sentinel启动完毕，我们登陆到任意一个sentinel上看一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">telnet localhost 26377</div><div class="line"></div><div class="line">执行 info 命令</div><div class="line"></div><div class="line"># Sentinel</div><div class="line">sentinel_masters:1</div><div class="line">sentinel_tilt:0</div><div class="line">sentinel_running_scripts:0</div><div class="line">sentinel_scripts_queue_length:0</div><div class="line">master0:name=mymaster,status=ok,address=172.30.8.109:6379,slaves=2,sentinels=3</div></pre></td></tr></table></figure>
<p><code>info</code> 信息展示，此时的redis集群中，master为6379实例，有两个salve，有三个sentinel</p>
<p>下面，我们开始测试<code>failover</code></p>
<p>我们登陆到现master，6379实例上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">telnet localhost 6379</div><div class="line"></div><div class="line">执行debug命令,让此实例block服务180s，模拟master挂掉了</div><div class="line">debug sleep 180</div></pre></td></tr></table></figure>
<p>由于我们的sentinel配置的检测sdown之间为30s，所以在30s之后，我们看一下sentinel中的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">telnet localhost 26377</div><div class="line"></div><div class="line">执行 info 命令</div><div class="line"></div><div class="line"># Sentinel</div><div class="line">sentinel_masters:1</div><div class="line">sentinel_tilt:0</div><div class="line">sentinel_running_scripts:0</div><div class="line">sentinel_scripts_queue_length:0</div><div class="line">master0:name=mymaster,status=ok,address=172.30.8.109:6378,slaves=2,sentinels=3</div></pre></td></tr></table></figure>
<p>sentinel中展示，当前的master已切换到了6378实例</p>
<p>我们再看下6378实例的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">telnet localhost 6378</div><div class="line"></div><div class="line">执行 info 命令</div><div class="line"></div><div class="line"># Replication</div><div class="line">role:master</div><div class="line">connected_slaves:1</div><div class="line">slave0:ip=172.30.8.109,port=6377,state=online,offset=675799,lag=0</div><div class="line">master_repl_offset:675799</div><div class="line">repl_backlog_active:1</div><div class="line">repl_backlog_size:1048576</div><div class="line">repl_backlog_first_byte_offset:658707</div><div class="line">repl_backlog_histlen:17093</div></pre></td></tr></table></figure>
<p>如上所示，6378果然被切换为master了，并且由于原master 6379实例，还在block中，当前的slave只有一个6377了；</p>
<p>可见，failover成功了！</p>
<p>当原master 6379服务恢复之后呢，会发生什么呢？</p>
<p>我们等那180s之后，再回来看6379的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">telnet localhost 6379</div><div class="line"></div><div class="line">执行 info 命令</div><div class="line"></div><div class="line"># Replication</div><div class="line">role:slave</div><div class="line">master_host:172.30.8.109</div><div class="line">master_port:6378</div><div class="line">master_link_status:up</div><div class="line">master_last_io_seconds_ago:1</div><div class="line">master_sync_in_progress:0</div></pre></td></tr></table></figure>
<p>可以看到，虽然6379起死回生了，但是格局已经变了，role由master变为了slave了；</p>
<p>此时，再看下6378的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">telnet localhost 6378</div><div class="line"></div><div class="line">执行 info 命令</div><div class="line"></div><div class="line"># Replication</div><div class="line">role:master</div><div class="line">connected_slaves:2</div><div class="line">slave0:ip=172.30.8.109,port=6377,state=online,offset=743713,lag=1</div><div class="line">slave1:ip=172.30.8.109,port=6379,state=online,offset=743435,lag=1</div><div class="line">master_repl_offset:743713</div><div class="line">repl_backlog_active:1</div></pre></td></tr></table></figure>
<p>没错，slave信息中6379出现了。</p>
<h3 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h3><p>failover 原理</p>
<p>在sentinel中，master状态有三种</p>
<ul>
<li>ok</li>
<li>sdown 主观下线</li>
<li>odown 客观下线</li>
</ul>
<p>工作太忙，有时间待续。。。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/15/architecture-one/" itemprop="url">
                  某系统架构
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-15T15:51:17+08:00" content="2016-07-15">
              2016-07-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/architecture/" itemprop="url" rel="index">
                    <span itemprop="name">architecture</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/15/architecture-one/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/15/architecture-one/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="https://raw.githubusercontent.com/monkeyissexy/attachment/master/images/paymax.png" alt="架构图"></p>
<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>本系统架构，是以实现一个高可用、可伸缩性强、用户体验佳、安全性好为目标而设计的。</p>
<h2 id="各层说明"><a href="#各层说明" class="headerlink" title="各层说明"></a>各层说明</h2><h3 id="前端层"><a href="#前端层" class="headerlink" title="前端层"></a>前端层</h3><blockquote>
<p>WEB、MOBILE、MERCHANT（商户服务器）</p>
</blockquote>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>提升开发效率</li>
<li>结构清晰</li>
<li>可读性强</li>
<li>可维护性强</li>
<li>前后端充分解耦</li>
<li>利于页面的加载优化</li>
</ul>
<p>WEB/MOBILE模块层，为纯js、css、html（angularjs+requirejs）架构，与服务器交互使用restful api接口；</p>
<p>采用angularjs+requirejs前端js框架，在提升开发效率的同时，使得前端代码结构分明、清晰、可读性强，增加前端代码的可维护性，这是传统页面无法做到的。</p>
<p>同时，这种方式有助于前后端充分解耦，完全面向restful接口开，使得前后端开发人员剥离开，与传统的jsp相比，前端开发不需要参和后端服务器代码，更纯粹、更专注；</p>
<p>另外这种纯静态的结构，借助CDN可大大提高页面加载速度，提升用户提现；</p>
<h3 id="API层"><a href="#API层" class="headerlink" title="API层"></a>API层</h3><blockquote>
<p>API（为商户后台提供接口）、MERCHANT-API（为商户提供交易接口）</p>
</blockquote>
<p>这两个API模块都采用了Restful接口规范，均使用SSL保证通信安全：</p>
<ul>
<li>安全性<ul>
<li>API 采用Oauth2.0标准协议，确保了接口安全性；</li>
<li>MERCHANT-API 采用双向非对称加密，确保了接口安全；</li>
</ul>
</li>
<li>高可用：前端采用SLB(阿里负载均衡)，服务器内部使用nginx做反向代理；</li>
<li>缓存：REST设计的一个原则为有效利用缓存，所有POST、PUT和DELETE请求均不缓存，这一点由浏览器自身保证，无需额外的配置。对于GET请求，必须合理地配置缓存头，从而提高部分接口的响应效率；</li>
</ul>
<h3 id="业务层"><a href="#业务层" class="headerlink" title="业务层"></a>业务层</h3><blockquote>
<p>所有业务逻辑都在这里</p>
</blockquote>
<ul>
<li>交易回调：处理各第三方支付系统的回调；</li>
<li>BUSINESS：串联所有基础服务模块，通过Dubbo连接（下面中间件会介绍）；</li>
<li>微信网关：处理所有与微信接口的调用；</li>
<li>后台：内部运营管理后台；</li>
</ul>
<h3 id="基础服务层"><a href="#基础服务层" class="headerlink" title="基础服务层"></a>基础服务层</h3><blockquote>
<p>微服务架构（MSA）是一种架构概念，旨在通过将功能分解到各个离散的服务中以实现对解决方案的解耦，基础服务层之间，不直接调用，通过可靠的MQ来通信（下面中间件会介绍）；</p>
</blockquote>
<ul>
<li><p>用户服务</p>
<p>   提供用户相关基础逻辑接口，登录、注册等等；</p>
</li>
<li><p>订单模块</p>
<p>  处理所有订单交易相关逻辑接口，提供查询接口、统计接口；</p>
</li>
<li><p>渠道模块</p>
<p>  连接外部各种第三方支付系统，内部与订单模块交互；</p>
</li>
<li><p>账单模块</p>
<p>  提供下载、存储所有商户在paymax的交易账单；</p>
</li>
<li><p>门店模块</p>
<p>  提供所有门店系统相关接口；</p>
</li>
<li><p>商户服务</p>
<p>  包含商户接入信息、资料等相关接口；</p>
</li>
<li><p>购物车模块</p>
<p>  商户可在购物车下单购买所需要的渠道；</p>
</li>
<li><p>消息模块</p>
<p>  提供sms、email发通知的功能；</p>
</li>
<li><p>api模块</p>
<p>  提供商户后台接口，接口安全使用oauth；</p>
</li>
<li><p>merchant-api模块</p>
<p>  提供交易相关接口，供商户服务器调用；</p>
</li>
</ul>
<h3 id="中间件层"><a href="#中间件层" class="headerlink" title="中间件层"></a>中间件层</h3><blockquote>
<p>ZOOKEEPER、REDIS、RDS、OSS、DUBBO、MQ</p>
</blockquote>
<ul>
<li>Zookeeper</li>
</ul>
<blockquote>
<p>ZooKeeper是一个高可用的分布式数据管理与系统协调框架。基于对Paxos算法的实现，使该框架保证了分布式环境中数据的强一致性</p>
</blockquote>
<p>使用zookeeper来处理分布式系统之间的协作，同时也保证了系统的一致性；</p>
<ul>
<li>Redis</li>
</ul>
<blockquote>
<p>配合zookeeper的leader模式，开发出高可用的redis集群，保证了系统的稳定；</p>
</blockquote>
<p>在系统中主要是提供了高可用的内存缓存角色，从而大大提高了系统效率；</p>
<ul>
<li><p>RDS</p>
<p>  使用的是阿里高可用的mysql，很好的解决了单点故障等问题；</p>
</li>
<li><p>OSS</p>
<p>  分布式文件存储系统，高可用；也利于做CDN优化加载，提升用户体验；</p>
</li>
<li><p>DUBBO</p>
</li>
</ul>
<blockquote>
<p>DUBBO是一个分布式服务框架，致力于提供高性能和透明化的RPC远程服务调用方案。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">透明：使得RPC接口管理变得透明；</div><div class="line">伸缩性：系统平行扩展很方便，可以根据业务量，很简单的弹性上下架服务实例；</div><div class="line">监控：可对接口的调用做监控，次数、效率等等，对暴露的问题提前优化；</div></pre></td></tr></table></figure>
<ul>
<li>MQ</li>
</ul>
<blockquote>
<p>使用了可靠的消息队列，添加了ack机制及发送策略；</p>
</blockquote>
<p>使得系统间解耦，可靠消息机制，也保证了系统间数据的一致性；</p>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><blockquote>
<p>采用zabbix，对各中间件、服务进程进行了监控，出现问题实时报警；</p>
</blockquote>
<h3 id="第三方依赖"><a href="#第三方依赖" class="headerlink" title="第三方依赖"></a>第三方依赖</h3><ul>
<li><p>天翼</p>
<p>  发短信</p>
</li>
<li><p>创蓝</p>
<p>  发短信</p>
</li>
<li><p>微信</p>
<p>  使用其提供的公众号相关接口，以及支付功能；</p>
</li>
<li><p>支付宝</p>
<p>  使用其提供的支付功能；</p>
</li>
<li><p>拉卡拉</p>
<p>  使用其提供的支付功能；</p>
</li>
<li><p>APPLE PAY</p>
<p>  使用其提供的支付功能；</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/13/jvm-optimization/" itemprop="url">
                  JVM 调优
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-13T14:33:17+08:00" content="2016-07-13">
              2016-07-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/13/jvm-optimization/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/13/jvm-optimization/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="内存划分"><a href="#内存划分" class="headerlink" title="内存划分"></a>内存划分</h2><blockquote>
<p>Java虚拟机规范，JVM将内存划分为：New、Tenured、Perm。其中New和Tenured属于堆内存，堆内存会从JVM启动参数（-Xmx:3G）指定的内存中分配，一般来讲：heap=Y+O，Sun推荐Y=heap*(3/8)；P是额外的值，P不属于堆内存，由虚拟机直接分配，但可以通过-XX:PermSize -XX:MaxPermSize 等参数调整其大小。</p>
</blockquote>
<ul>
<li>New（年轻代）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">年轻代用来存放JVM刚分配的Java对象</div></pre></td></tr></table></figure>
<ul>
<li>Tenured（年老代）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">年轻代中经过垃圾回收没有回收掉的对象将被Copy到年老代</div></pre></td></tr></table></figure>
<ul>
<li>永久代（Perm）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">永久代存放Class、Method元信息，</div><div class="line">其大小跟项目的规模、类、方法的量有关，一般设置为128M就足够，</div><div class="line">设置原则是预留30%的空间。</div></pre></td></tr></table></figure>
<ul>
<li>New（年轻代 <code>E＋S0＋S1＝Y</code>）分为：<ul>
<li>Eden：Eden用来存放JVM刚分配的对象</li>
<li>Survivor1</li>
<li>Survivro2：两个Survivor空间一样大，当Eden中的对象经过垃圾回收没有被回收掉时，会在两个Survivor之间来回Copy，当满足某个条件，比如Copy次数，就会被Copy到Tenured。显然，Survivor只是增加了对象在年轻代中的逗留时间，增加了被垃圾回收的可能性。</li>
</ul>
</li>
</ul>
<h2 id="内存参数说明"><a href="#内存参数说明" class="headerlink" title="内存参数说明"></a>内存参数说明</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">-Xmx5000M // max的heap的大小</div><div class="line">-Xms5000M // min的heap的大小</div><div class="line">-Xmn2000M // young区的大小，E＋S0＋S1＝Y</div><div class="line"></div><div class="line">因heap=y+o，</div><div class="line">如此就决定了old区大小为3000m </div><div class="line">或者 </div><div class="line">若不设置Xmn，可以使用newRatio配置y和o的比例；</div><div class="line"></div><div class="line">-Xss256k // 每个线程的堆栈大小, JDK5.0以后每个线程堆栈大小为1M，</div><div class="line">以前每个线程堆栈大小为256K.根据应用的线程所需内存大小进行调整；</div><div class="line">这个Stack Space不是来自Heap的分配。</div><div class="line">所以Stack Space的大小不会受到-Xmx和-Xms的影响</div><div class="line">Stack Space用尽之后，会抛出StackOverflow异常</div></pre></td></tr></table></figure>
<h2 id="一些工具的使用"><a href="#一些工具的使用" class="headerlink" title="一些工具的使用"></a>一些工具的使用</h2><h3 id="jps-Java-Virtual-Machine-Process-Status-Tool"><a href="#jps-Java-Virtual-Machine-Process-Status-Tool" class="headerlink" title="jps (Java Virtual Machine Process Status Tool)"></a>jps (Java Virtual Machine Process Status Tool)</h3><ul>
<li>查看所有jvm进程id</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jps</div></pre></td></tr></table></figure>
<h3 id="jmap-Java-Memory-Map"><a href="#jmap-Java-Memory-Map" class="headerlink" title="jmap (Java Memory Map)"></a>jmap (Java Memory Map)</h3><ul>
<li>dump该pid的内存使用情况（二进制文件，需要借助工具MAT-Memory Analysis Tool 或者 jhat-Java Heap Analysis Tool分析）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jmap -dump:format=b,file=outfile 5893</div></pre></td></tr></table></figure>
<ul>
<li>打印每个class的实例数目统计排行,内存占用,类全名信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jmap -histo 5893 &gt; outfile</div></pre></td></tr></table></figure>
<ul>
<li>打印heap的概要信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jmap -heap 5893 &gt; outfile</div></pre></td></tr></table></figure>
<blockquote>
<p>详细</p>
<pre><code>-dump:[live,]format=b,file=&lt;filename&gt; 使用hprof二进制形式,输出jvm的heap内容到文件=. live子选项是可选的，假如指定live选项,那么只输出活的对象到文件. 
-finalizerinfo 打印正等候回收的对象的信息.
-heap 打印heap的概要信息，GC使用的算法，heap的配置及wise heap的使用情况.
-histo[:live] 打印每个class的实例数目,内存占用,类全名信息. VM的内部类名字开头会加上前缀”*”. 如果live子参数加上后,只统计活的对象数量. 
-permstat 打印classload和jvm heap长久层的信息. 包含每个classloader的名字,活泼性,地址,父classloader和加载的class数量. 另外,内部String的数量和占用内存数也会打印出来. 
-F 强迫.在pid没有相应的时候使用-dump或者-histo参数. 在这个模式下,live子参数无效. 
-h | -help 打印辅助信息 
-J 传递参数给jmap启动的jvm. 
</code></pre></blockquote>
<h3 id="jstack-Java-Stack-Trace"><a href="#jstack-Java-Stack-Trace" class="headerlink" title="jstack(Java Stack Trace)"></a>jstack(Java Stack Trace)</h3><blockquote>
<p>dump该pid下的堆栈信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jstack -l 5893 &gt; outfile</div></pre></td></tr></table></figure>
<h3 id="jstat-Java-Virtual-Machine-Statistics-Monitoring-Tool"><a href="#jstat-Java-Virtual-Machine-Statistics-Monitoring-Tool" class="headerlink" title="jstat (Java Virtual Machine Statistics Monitoring Tool)"></a>jstat (Java Virtual Machine Statistics Monitoring Tool)</h3><blockquote>
<p>Jstat用于监控基于HotSpot的JVM，对其堆的使用情况进行实时的命令行的统计.</p>
</blockquote>
<p>jstat -gcutil 20538 1000 100</p>
<h3 id="jhat-Java-Heap-Analyse-Tool"><a href="#jhat-Java-Heap-Analyse-Tool" class="headerlink" title="jhat (Java Heap Analyse Tool)"></a>jhat (Java Heap Analyse Tool)</h3><blockquote>
<p>用来分析java堆的命令(依赖jmap导出的bin文件)，可以将堆中的对象以html的形式显示出来，包括对象的数量，大小等等</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jhat jmapoutfile</div></pre></td></tr></table></figure>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="问题服务情况"><a href="#问题服务情况" class="headerlink" title="问题服务情况"></a>问题服务情况</h3><p> 该进程的端口存活，但无法对外提供服务，该服务有定时任务、rmi接口，但整体压力不大，不应出现这种情况；</p>
<h3 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h3><ul>
<li>该实例jvm内存参数配置如下（Xss为每个thread的内存占用，ps：太小了点）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Xmx128m -Xms128m -Xmn64m -XX:MaxPermSize=64m -Xss256k</div></pre></td></tr></table></figure>
<ul>
<li>查看实时gc情况</li>
</ul>
<blockquote>
<p>old区使用率一直是100%，fgc平均每秒两到三次，明细异常，且fgc之后无效果；</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@payright01 bin]# /usr/java/default/bin/jstat -gcutil 8862 1000 100</div><div class="line">  S0     S1     E      O      P     YGC     YGCT    FGC    FGCT     GCT</div><div class="line">  0.00   0.00  78.78 100.00  84.83    891    2.789 40382 1298.644 1301.434</div><div class="line">  0.00   0.00  78.78 100.00  84.83    891    2.789 40384 1298.721 1301.511</div><div class="line">  0.00   0.00  79.05 100.00  84.83    891    2.789 40386 1298.800 1301.590</div><div class="line">  0.00   0.00  79.08 100.00  84.83    891    2.789 40388 1298.878 1301.667</div><div class="line">  0.00   0.00  79.08 100.00  84.83    891    2.789 40388 1298.878 1301.667</div><div class="line">  0.00   0.00  79.14 100.00  84.83    891    2.789 40390 1298.957 1301.747</div><div class="line">  0.00   0.00  79.46 100.00  84.83    891    2.789 40390 1298.957 1301.747</div><div class="line">  0.00   0.00  79.56 100.00  84.83    891    2.789 40392 1299.035 1301.824</div><div class="line">  0.00   0.00  79.56 100.00  84.83    891    2.789 40392 1299.035 1301.824</div><div class="line">  0.00   0.00  79.68 100.00  84.83    891    2.789 40396 1299.195 1301.985</div><div class="line">  0.00   0.00  79.70 100.00  84.83    891    2.789 40396 1299.195 1301.985</div><div class="line">  0.00   0.00  79.73 100.00  84.83    891    2.789 40397 1299.232 1302.021</div><div class="line">  0.00   0.00  79.81 100.00  84.83    891    2.789 40400 1299.357 1302.147</div><div class="line">  0.00   0.00  79.95 100.00  84.83    891    2.789 40400 1299.357 1302.147</div><div class="line">  0.00   0.00  79.95 100.00  84.83    891    2.789 40402 1299.436 1302.225</div><div class="line">  0.00   0.00  82.09 100.00  84.88    891    2.789 40402 1299.436 1302.225</div><div class="line">  0.00   0.00  82.09 100.00  84.88    891    2.789 40404 1299.520 1302.309</div><div class="line">  0.00   0.00  82.31 100.00  84.88    891    2.789 40406 1299.601 1302.391</div><div class="line">  0.00   0.00  82.34 100.00  84.88    891    2.789 40406 1299.601 1302.391</div><div class="line">  0.00   0.00  82.34 100.00  84.88    891    2.789 40408 1299.681 1302.471</div><div class="line">  0.00   0.00  82.40 100.00  84.88    891    2.789 40408 1299.681 1302.471</div><div class="line">  0.00   0.00  82.49 100.00  84.88    891    2.789 40410 1299.761 1302.550</div><div class="line">  0.00   0.00  82.61 100.00  84.88    891    2.789 40412 1299.844 1302.633</div><div class="line">  0.00   0.00  82.61 100.00  84.88    891    2.789 40412 1299.844 1302.633</div><div class="line">  0.00   0.00  82.67 100.00  84.88    891    2.789 40414 1299.926 1302.715</div><div class="line">  0.00   0.00  82.75 100.00  84.88    891    2.789 40414 1299.926 1302.715</div><div class="line">  0.00   0.00  82.77 100.00  84.88    891    2.789 40416 1300.012 1302.801</div><div class="line">  0.00   0.00  82.86 100.00  84.88    891    2.789 40418 1300.098 1302.888</div></pre></td></tr></table></figure>
<ul>
<li>查看heap内存情况</li>
</ul>
<blockquote>
<p>显示的old区使用情况，<code>99.99994039535522% used</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">Heap Usage:</div><div class="line">New Generation (Eden + 1 Survivor Space):</div><div class="line">   capacity = 60424192 (57.625MB)</div><div class="line">   used     = 34197720 (32.613487243652344MB)</div><div class="line">   free     = 26226472 (25.011512756347656MB)</div><div class="line">   56.596073307856564% used</div><div class="line">Eden Space:</div><div class="line">   capacity = 53739520 (51.25MB)</div><div class="line">   used     = 34197720 (32.613487243652344MB)</div><div class="line">   free     = 19541800 (18.636512756347656MB)</div><div class="line">   63.63607267054116% used</div><div class="line">From Space:</div><div class="line">   capacity = 6684672 (6.375MB)</div><div class="line">   used     = 0 (0.0MB)</div><div class="line">   free     = 6684672 (6.375MB)</div><div class="line">   0.0% used</div><div class="line">To Space:</div><div class="line">   capacity = 6684672 (6.375MB)</div><div class="line">   used     = 0 (0.0MB)</div><div class="line">   free     = 6684672 (6.375MB)</div><div class="line">   0.0% used</div><div class="line">concurrent mark-sweep generation:</div><div class="line">   capacity = 67108864 (64.0MB)</div><div class="line">   used     = 67108824 (63.999961853027344MB)</div><div class="line">   free     = 40 (3.814697265625E-5MB)</div><div class="line">   99.99994039535522% used</div><div class="line">Perm Generation:</div><div class="line">   capacity = 67108864 (64.0MB)</div><div class="line">   used     = 56929048 (54.291770935058594MB)</div><div class="line">   free     = 10179816 (9.708229064941406MB)</div></pre></td></tr></table></figure>
<ul>
<li>dump jvm内存使用bin文件，以便后续分析</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/java/default/bin/jmap -dump:format=b,file=outfile.bin pid</div></pre></td></tr></table></figure>
<ul>
<li>统计每个class的实例数量、内存占用、排名情况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">/usr/java/default/bin/jmap -histo 14775 | less</div><div class="line"></div><div class="line"> num     #instances         #bytes  class name</div><div class="line">----------------------------------------------</div><div class="line">   1:        116173       21598256  [B</div><div class="line">   2:        219353       20803688  [C</div><div class="line">   3:         97897       13922848  &lt;constMethodKlass&gt;</div><div class="line">   4:         97897       12542048  &lt;methodKlass&gt;</div><div class="line">   5:          9910       10627384  &lt;constantPoolKlass&gt;</div><div class="line">   6:        262461        8398752  java.util.HashMap$Entry</div><div class="line">   7:        231323        7402336  java.util.LinkedList</div><div class="line">   8:          9910        7169760  &lt;instanceKlassKlass&gt;</div><div class="line">   9:         64176        6397688  [Ljava.util.HashMap$Entry;</div><div class="line">  10:         84073        6098496  [I</div><div class="line">  11:          8182        5993312  &lt;constantPoolCacheKlass&gt;</div><div class="line">  12:        158695        3808680  java.lang.String</div><div class="line">  13:        114925        3677600  org.apache.commons.httpclient.HostConfiguration</div><div class="line">  14:        114818        3674176  org.apache.commons.httpclient.MultiThreadedHttpConnectionManager$HostConnectionPool</div><div class="line">  15:         68160        3271680  java.util.HashMap</div><div class="line">  16:          5874        2943928  &lt;methodDataKlass&gt;</div><div class="line">  17:        115029        2760696  org.apache.commons.httpclient.params.HostParams</div><div class="line">  18:        114924        2758176  org.apache.commons.httpclient.HttpHost</div><div class="line">  19:         38299        2757528  org.apache.commons.httpclient.MultiThreadedHttpConnectionManager$HttpConnectionWithReference</div><div class="line">  20:         44555        1782200  java.util.HashMap$KeyIterator</div><div class="line">  21:         36937        1727040  [Ljava.lang.Object;</div><div class="line">  22:         45526        1456832  java.lang.ref.WeakReference</div><div class="line">  23:         10577        1009176  java.lang.Class</div><div class="line">  24:         40034         960816  java.util.LinkedList$Node</div><div class="line">  25:         39564         949536  java.lang.Long</div><div class="line">  26:         23641         945640  java.util.LinkedHashMap$Entry</div></pre></td></tr></table></figure>
<h3 id="可疑点"><a href="#可疑点" class="headerlink" title="可疑点"></a>可疑点</h3><ol>
<li>old区满了之后，fgc无法释放，怀疑可能有<code>内存泄漏</code>情况；</li>
<li>jvm heap old区应占整个heap区的5/8，young区占3/8，但当前old区:young区为1:1，都为64M，不合理；</li>
<li>heap整体内存太小，不够用；</li>
</ol>
<h3 id="尝试解决"><a href="#尝试解决" class="headerlink" title="尝试解决"></a>尝试解决</h3><h4 id="修改进程的jvm参数配置"><a href="#修改进程的jvm参数配置" class="headerlink" title="修改进程的jvm参数配置"></a>修改进程的jvm参数配置</h4><blockquote>
<p>增加heap内存配置，不适用young的newRatio比例配置，使用设置固定数值，young区设定为128m，则old为384m，使得old区的比例基本为(5/8)*heap；</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-Xmx512m -Xms512m -Xmn128m -XX:MaxPermSize=64m -Xss256k</div></pre></td></tr></table></figure>
<ul>
<li>重启服务之后，查看gc情况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@payright01 payright-channel]# /usr/java/default/bin/jstat -gcutil 27110 1000 100</div><div class="line">  S0     S1     E      O      P     YGC     YGCT    FGC    FGCT     GCT</div><div class="line">  0.00  67.51  73.62  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.62  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.62  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.67  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.73  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.85  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.91  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.91  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.91  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.91  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.99  10.10  79.61     63    0.543     4    0.346    0.889</div><div class="line">  0.00  67.51  73.99  10.10  79.61     63    0.543     4    0.346    0.889</div></pre></td></tr></table></figure>
<ul>
<li>查看heap整体内存使用情况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Heap Usage:</div><div class="line">New Generation (Eden + 1 Survivor Space):</div><div class="line">   capacity = 120848384 (115.25MB)</div><div class="line">   used     = 87641888 (83.58181762695312MB)</div><div class="line">   free     = 33206496 (31.668182373046875MB)</div><div class="line">   72.5221844919333% used</div><div class="line">Eden Space:</div><div class="line">   capacity = 107479040 (102.5MB)</div><div class="line">   used     = 78616696 (74.97472381591797MB)</div><div class="line">   free     = 28862344 (27.52527618408203MB)</div><div class="line">   73.14607201552973% used</div><div class="line">From Space:</div><div class="line">   capacity = 13369344 (12.75MB)</div><div class="line">   used     = 9025192 (8.607093811035156MB)</div><div class="line">   free     = 4344152 (4.142906188964844MB)</div><div class="line">   67.50661812576593% used</div><div class="line">To Space:</div><div class="line">   capacity = 13369344 (12.75MB)</div><div class="line">   used     = 0 (0.0MB)</div><div class="line">   free     = 13369344 (12.75MB)</div><div class="line">   0.0% used</div><div class="line">concurrent mark-sweep generation:</div><div class="line">   capacity = 402653184 (384.0MB)</div><div class="line">   used     = 40668864 (38.78485107421875MB)</div><div class="line">   free     = 361984320 (345.21514892578125MB)</div><div class="line">   10.100221633911133% used</div><div class="line">Perm Generation:</div><div class="line">   capacity = 67108864 (64.0MB)</div><div class="line">   used     = 53423032 (50.94817352294922MB)</div><div class="line">   free     = 13685832 (13.051826477050781MB)</div><div class="line">   79.60652112960815% used</div></pre></td></tr></table></figure>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>参数调整之后，fgc和ygc次数正常，服务正常；</p>
<p>但也不能认为就此就解决问题了，很可能是把参数调大了，暂时放缓了问题的出现，还需要多观察几天看下；</p>
<p>在观察的同时，需要根据上面第4步dump出来的当时jvm的内存使用情况的bin文件，分析有没有内存泄漏的情况；</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/11/restart_tutorials/" itemprop="url">
                  断电重启教程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-11T11:37:17+08:00" content="2016-07-11">
              2016-07-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/work/" itemprop="url" rel="index">
                    <span itemprop="name">work</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/11/restart_tutorials/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/11/restart_tutorials/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="断电重启教程"><a href="#断电重启教程" class="headerlink" title="断电重启教程"></a>断电重启教程</h3><ul>
<li>nginx</li>
</ul>
<blockquote>
<p>执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">开发/测试</div><div class="line">	nginx</div><div class="line">	</div><div class="line">验证</div><div class="line">	ps -ef|grep nginx</div></pre></td></tr></table></figure>
<ul>
<li>redis</li>
</ul>
<blockquote>
<p>执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">开发</div><div class="line">	/root/software/redis-3.0.7/src/redis-server	/root/software/redis-3.0.7/redis.conf  </div><div class="line">	</div><div class="line">测试</div><div class="line">	redis-server /etc/redis.conf	</div><div class="line">	</div><div class="line">验证</div><div class="line">	telnet localhost 6379</div></pre></td></tr></table></figure>
<ul>
<li>kestrel</li>
</ul>
<blockquote>
<p>执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">开发</div><div class="line">	/root/software/kestrel-2.4.1/scripts/kestrel.sh start</div><div class="line"></div><div class="line">测试</div><div class="line">	/data/payright/kestrel-2.4.1/scripts/kestrel.sh start</div><div class="line"></div><div class="line">验证</div><div class="line">telnet localhost 22133</div></pre></td></tr></table></figure>
<ul>
<li>zookeeper</li>
</ul>
<blockquote>
<p>执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">开发</div><div class="line">	/root/software/zookeeper-3.4.6/bin/zkServer.sh start</div><div class="line">	</div><div class="line">测试</div><div class="line">	/data/payright/zookeeper-3.4.6/bin/zkServer.sh start</div><div class="line">	</div><div class="line">验证</div><div class="line">	telnet localhost 2181</div></pre></td></tr></table></figure>
<ul>
<li>mysql</li>
</ul>
<blockquote>
<p>执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">开发/测试</div><div class="line">	mkdir -p /var/log/mariadb</div><div class="line">	mkdir -p /var/run/mariadb</div><div class="line">	chown mysql:mysql /var/run/mariadb</div><div class="line">	chown mysql:mysql /var/log/mariadb</div><div class="line">	</div><div class="line">	cd /usr/local/mysql</div><div class="line">	bin/mysqld_safe --user=mysql &amp;</div><div class="line">	cp support-files/mysql.server /etc/init.d/mysql.server</div><div class="line">	</div><div class="line">验证</div><div class="line">	mysql_root</div></pre></td></tr></table></figure>
<ul>
<li>dubbo.monitor</li>
</ul>
<blockquote>
<p>执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">开发</div><div class="line">	/root/software/dubbo.monitor/bin/start.sh</div><div class="line">	</div><div class="line">测试</div><div class="line">	/data/payright/dubbo.monitor/bin/start.sh</div><div class="line">	</div><div class="line">验证</div><div class="line">	telnet localhost 18097</div></pre></td></tr></table></figure>
<ul>
<li>关闭防火墙</li>
</ul>
<blockquote>
<p>执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">开发/测试</div><div class="line">	systemctl stop firewalld</div><div class="line">	</div><div class="line">验证</div><div class="line">	systemctl status firewalld</div></pre></td></tr></table></figure>
<ul>
<li>重启所有服务</li>
</ul>
<blockquote>
<p>执行命令</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">开发/测试</div><div class="line">	ansible-playbook /data/oam/deploy/payright-*</div><div class="line"></div><div class="line">验证</div><div class="line">	browser to `http://ip:18097/services.html`</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/09/breakpoint-upload/" itemprop="url">
                  断点续传
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-09T19:51:17+08:00" content="2016-07-09">
              2016-07-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/other/" itemprop="url" rel="index">
                    <span itemprop="name">other</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/09/breakpoint-upload/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/09/breakpoint-upload/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>项目中遇到有通过手机App拍摄并上传视频的功能，而视频一般都比较大，当然也可以限制格式和前端大小限制解决，但是出于好奇，还是调研了下断点续传：</p>
<h3 id="使用场景："><a href="#使用场景：" class="headerlink" title="使用场景："></a>使用场景：</h3><blockquote>
<p>多为手机端</p>
</blockquote>
<ol>
<li>网络情况比较差，前端和服务器经常会断开连接；</li>
<li>上传文件较大；</li>
<li>上传文件大小未知；</li>
</ol>
<h3 id="原理简述："><a href="#原理简述：" class="headerlink" title="原理简述："></a>原理简述：</h3><ol>
<li>客户端（native）将文件做md5值；</li>
<li>客户端（native）根据指定的block大小（假设：每块10M）和文件总大小（假设：100M）计算最终的block数（10）；</li>
<li>客户端（native）将文件信息发送到服务器，包括要上传的文件名、大小、类型、块数、md5值；</li>
<li>服务器端（server-api）根据md5值，查询服务器上是否已经存在对应的文件，以及文件的上传状态（上传是否完成、文件块是否已合并、已上传block数量）；</li>
<li>若已经上传完成，将文件URL地址返回给客户端（native）；</li>
<li>若未上传完成，将已经上传的block编号返回给客户端（native）； </li>
<li>客户端（native）根据返回值判断，如果未上传完成，则从本地文件中读取未上传完成的块内容；</li>
<li>客户端（native）使用HTTP方式上传到服务器；</li>
<li>当这个block上传完毕之后，服务器端将已经上传完成的块到数据库；</li>
<li>服务器端检查整个文件是否已经上传完成；</li>
<li>若未完成，则返回已经上传的块编号到客户端（native）让它继续上传；</li>
<li>若上传完成，则进行块文件合并过程，将其合并成目标文件；</li>
<li>合并完成后，服务器将最终的文件URL地址返回给客户端；</li>
</ol>
<h3 id="分两部分工作："><a href="#分两部分工作：" class="headerlink" title="分两部分工作："></a>分两部分工作：</h3><ul>
<li>前端和server-api的断点上传<ul>
<li>服务器端、native端都好支持，需要额外code进行处理；</li>
<li>web端可基于h5 websocket来支持；<br>  （参考）<a href="http://my.oschina.net/u/590484/blog/74054，需要自己写code，简单调研下，web端难度大一点）；" target="_blank" rel="external">http://my.oschina.net/u/590484/blog/74054，需要自己写code，简单调研下，web端难度大一点）；</a></li>
</ul>
</li>
<li>server-api和阿里云OSS的断点上传（OSS有断点上传的接口支持，简单的写一些code）；</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/08/java8-lambda/" itemprop="url">
                  Java8 Lambda
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-08T23:04:17+08:00" content="2016-07-08">
              2016-07-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Java8/" itemprop="url" rel="index">
                    <span itemprop="name">Java8</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/08/java8-lambda/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/08/java8-lambda/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>转载 原文：<a href="http://blog.csdn.net/zxhoo/article/details/38349011" target="_blank" rel="external">http://blog.csdn.net/zxhoo/article/details/38349011</a></p>
</blockquote>
<h3 id="函数式接口"><a href="#函数式接口" class="headerlink" title="函数式接口"></a>函数式接口</h3><p>理解Functional Interface（函数式接口，以下简称FI）是学习Java8 Lambda表达式的关键所在，所以放在最开始讨论。FI的定义其实很简单：任何接口，如果只包含 唯一 一个抽象方法，那么它就是一个FI。为了让编译器帮助我们确保一个接口满足FI的要求（也就是说有且仅有一个抽象方法），Java8提供了@FunctionalInterface注解。举个简单的例子，Runnable接口就是一个FI，下面是它的源代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FunctionalInterface</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Lambda语法"><a href="#Lambda语法" class="headerlink" title="Lambda语法"></a>Lambda语法</h3><p>为了能够方便、快捷、幽雅的创建出FI的实例，Java8提供了Lambda表达式这颗语法糖。下面我用一个例子来介绍Lambda语法。假设我们想对一个List<string>按字符串长度进行排序，那么在Java8之前，可以借助匿名内部类来实现：</string></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">List&lt;String&gt; words = Arrays.asList(<span class="string">"apple"</span>, <span class="string">"banana"</span>, <span class="string">"pear"</span>);</div><div class="line">words.sort(<span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String w1, String w2)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Integer.compare(w1.length(), w2.length());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>上面的匿名内部类简直可以用丑陋来形容，唯一的一行逻辑被五行垃圾代码淹没。根据前面的定义（并查看Java源代码）可知，Comparator是个FI，所以，可以用Lambda表达式来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">words.sort((String w1, String w2) -&gt; &#123;</div><div class="line">    <span class="keyword">return</span> Integer.compare(w1.length(), w2.length());</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>代码变短了好多！仔细观察就会发现，Lambda表达式，很像一个匿名的方法，只是圆括号内的参数列表和花括号内的代码被-&gt;分隔开了。垃圾代码写的越少，我们就有越多的时间去写真正的逻辑代码，不是吗？是的！圆括号里的参数类型是可以省略的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">words.sort((w1, w2) -&gt; &#123;</div><div class="line">    <span class="keyword">return</span> Integer.compare(w1.length(), w2.length());</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果Lambda表达式的代码块只是return后面跟一个表达式，那么还可以进一步简化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">words.sort(</div><div class="line">    (w1, w2) -&gt; Integer.compare(w1.length(), w2.length())</div><div class="line">);</div></pre></td></tr></table></figure>
<p>注意，表达式后面是没有分号的！如果只有一个参数，那么包围参数的圆括号可以省略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">words.forEach(word -&gt; &#123;</div><div class="line">    System.out.println(word);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果表达式不需要参数呢？好吧，那也必须有圆括号，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Executors.newSingleThreadExecutor().execute(</div><div class="line">    () -&gt; &#123;<span class="comment">/* do something. */</span>&#125; <span class="comment">// Runnable</span></div><div class="line">);</div></pre></td></tr></table></figure>
<h4 id="方法引用"><a href="#方法引用" class="headerlink" title="方法引用"></a>方法引用</h4><p>有时候Lambda表达式的代码就只是一个简单的方法调用而已，遇到这种情况，Lambda表达式还可以进一步简化为 方法引用（Method References） 。一共有四种形式的方法引用，第一种引用 静态方法 ，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">List&lt;Integer&gt; ints = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</div><div class="line">ints.sort(Integer::compare);</div></pre></td></tr></table></figure>
<ul>
<li>第二种引用 某个特定对象的实例方法</li>
</ul>
<p>例如前面那个遍历并打印每一个word的例子可以写成这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">words.forEach(System.out::println);</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="hongliang wang" />
          <p class="site-author-name" itemprop="name">hongliang wang</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hongliang wang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"monkeyissexy"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
